# .github/workflows/telegram-reminder.yml
# -----------------------------------------------------------------------------
# Monthly YouTube Premium Reminder Workflow
# Purpose: To send automated, professional, yet friendly reminders to YouTube
# Premium family members about their monthly contribution and plan renewal.
# Sends reminders to a group chat and as private messages (PMs) to individuals.
# Includes automatic pinning of group reminder messages with notifications.
# -----------------------------------------------------------------------------

name: Monthly YouTube Premium Reminder

on:
  schedule:
    # 🗓️ Reminder Schedule (All times in IST - Indian Standard Time)
    # Reminder 1: Early Heads-Up - Har mahine ki 1 tareekh ko subah 10:30 AM IST (05:00 UTC)
    - cron: '0 5 1 * *' 
    # Reminder 2: Day Before Due - Har mahine ki 4 tareekh ko subah 10:30 AM IST (05:00 UTC)
    - cron: '0 5 4 * *'
    # Reminder 3: Due Date - Har mahine ki 5 tareekh ko subah 10:30 AM IST (05:00 UTC)
    - cron: '0 5 5 * *'
    # Reminder 4: Renewal Day - Har mahine ki 8 tareekh ko raat 10:00 PM IST (16:30 UTC)
    - cron: '30 16 8 * *'
  
  # Manually trigger karne ke liye
  workflow_dispatch:

# -----------------------------------------------------------------------------
# IMPORTANT: Configure these as GitHub Secrets in your repository settings!
# - TELEGRAM_BOT_TOKEN: Your Telegram Bot's API Token
# - TELEGRAM_TO: The Chat ID of your main Telegram group (e.g., -123456789)
# - AMIT_CHAT_ID: Amit's personal Telegram Chat ID (e.g., 123456789)
# - ALAN_CHAT_ID: Alan D'Souza's personal Telegram Chat ID
# - MOURYA_CHAT_ID: Mourya Baruah's personal Telegram Chat ID
# - ABHISHEK_CHAT_ID: Abhishek Kumar's personal Telegram Chat ID
# - SLOT5_CHAT_ID: Your personal Telegram Chat ID for Slot 5
# - SLOT6_CHAT_ID: Personal Telegram Chat ID for Slot 6 (if applicable)
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# JOBS SECTION: Different notifications for different days
# -----------------------------------------------------------------------------
jobs:
  # 📅 Job 1: Early Heads-Up (1st of the month) - Group + PMs + Loud Pinning
  send_telegram_reminder_1st:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 5 1 * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ⬇️ Check out repository code
        uses: actions/checkout@v4

      - name: 📦 Install JQ for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 🗓️ Get current month and year
        id: date
        run: |
          echo "MONTH=$(date +'%B')" >> $GITHUB_ENV
          echo "YEAR=$(date +'%Y')" >> $GITHUB_ENV
          # Define member chat IDs from secrets for easy access
          echo "AMIT_CHAT_ID=${{ secrets.AMIT_CHAT_ID }}" >> $GITHUB_ENV
          echo "ALAN_CHAT_ID=${{ secrets.ALAN_CHAT_ID }}" >> $GITHUB_ENV
          echo "MOURYA_CHAT_ID=${{ secrets.MOURYA_CHAT_ID }}" >> $GITHUB_ENV
          echo "ABHISHEK_CHAT_ID=${{ secrets.ABHISHEK_CHAT_ID }}" >> $GITHUB_ENV

      - name: ✉️ Send Early Reminder to Group & Capture ID
        id: send_group_message_1
        run: |
          # Message content for group
          GROUP_MESSAGE="🔔 <b>YouTube Premium: Monthly Contribution Reminder</b> 🔔

          Dear Team,

          This is a friendly heads-up regarding your upcoming ₹50 contribution for the YouTube Premium family plan. The payment is due by ${{ env.MONTH }} 5, ${{ env.YEAR }}, with renewal on <b>${{ env.MONTH }} 8, ${{ env.YEAR }}</b>.

          <i>Please ignore this message if you have already made your payment.</i> Your cooperation is much appreciated! 🙏

          <b>Current Members:</b>
          1. Amit
          2. Alan D'Souza
          3. Mourya Baruah
          4. Abhishek Kumar
          5. Slot 5 – Managed by Me
          6. Slot 6 – Managed by Me

          Happy streaming! 📺🎶"

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
            -d "text=${GROUP_MESSAGE}" \
            -d "parse_mode=HTML" # Using HTML for consistent rendering
          )
          
          MESSAGE_ID=$(echo "$RESPONSE" | jq -r '.result.message_id')
          echo "::set-output name=message_id::$MESSAGE_ID"
          echo "Sent group message with ID: $MESSAGE_ID" # For debugging

      - name: 📌 Pin the Early Reminder Message (LOUD) in Group
        if: steps.send_group_message_1.outputs.message_id != '' # Only try to pin if message was sent successfully
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/pinChatMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
            -d "message_id=${{ steps.send_group_message_1.outputs.message_id }}" \
            # Removed disable_notification=true for loud pinning
        env:
          MESSAGE_ID: ${{ steps.send_group_message_1.outputs.message_id }}

      - name: 📸 Send QR Code for Payment (1st)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          photo: ./.github/workflows/QRcode.png
          message: |
            Here's the QR code for your convenience: 💳

      - name: ✉️ Send Early Reminder as PMs to All Members
        run: |
          # Message content for PMs (slightly personalized)
          PM_MESSAGE="🔔 Hey there! Just a friendly reminder for your YouTube Premium contribution.

          Your ₹50 payment is due by ${{ env.MONTH }} 5, ${{ env.YEAR }}. The plan renews on ${{ env.MONTH }} 8, ${{ env.YEAR }}.

          Please ignore if you've already paid. Thanks for your support! 🙏
          "
          # List of member chat IDs to send PMs to
          MEMBER_CHATS=("${{ env.AMIT_CHAT_ID }}" "${{ env.ALAN_CHAT_ID }}" "${{ env.MOURYA_CHAT_ID }}" "${{ env.ABHISHEK_CHAT_ID }}")

          for CHAT_ID in "${MEMBER_CHATS[@]}"; do
            if [ -n "$CHAT_ID" ]; then # Check if chat ID is not empty
              echo "Sending PM to: $CHAT_ID"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=${PM_MESSAGE}" \
                -d "parse_mode=HTML" > /dev/null # Suppress output for multiple PMs
            else
              echo "Skipping empty chat ID."
            fi
          done

  # 🗓️ Job 2: Day Before Due Date (4th of the month) - Group + PMs + Loud Pinning
  send_telegram_reminder_4th:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 5 4 * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ⬇️ Check out repository code
        uses: actions/checkout@v4

      - name: 📦 Install JQ for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 🗓️ Get current month and year
        id: date
        run: |
          echo "MONTH=$(date +'%B')" >> $GITHUB_ENV
          echo "YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "AMIT_CHAT_ID=${{ secrets.AMIT_CHAT_ID }}" >> $GITHUB_ENV
          echo "ALAN_CHAT_ID=${{ secrets.ALAN_CHAT_ID }}" >> $GITHUB_ENV
          echo "MOURYA_CHAT_ID=${{ secrets.MOURYA_CHAT_ID }}" >> $GITHUB_ENV
          echo "ABHISHEK_CHAT_ID=${{ secrets.ABHISHEK_CHAT_ID }}" >> $GITHUB_ENV
          

      - name: ✉️ Send Day Before Due Reminder to Group & Capture ID
        id: send_group_message_4
        run: |
          # Message content for group
          GROUP_MESSAGE="⚠️ <b>YouTube Premium: Payment Due Tomorrow!</b> ⚠️

          Hello everyone,

          Just a gentle reminder: your ₹50 contribution for YouTube Premium is due <b>tomorrow, ${{ env.MONTH }} 5, ${{ env.YEAR }}</b>. The plan will renew on <b>${{ env.MONTH }} 8, ${{ env.YEAR }}</b>.

          Please ensure your payment is made soon to enjoy uninterrupted service! 🏃‍♂️
          <i>Kindly disregard this message if you have already submitted your payment.</i> Thank you! 🙏

          <b>Current Members:</b>
          1. Amit
          2. Alan D'Souza
          3. Mourya Baruah
          4. Abhishek Kumar
          5. Slot 5 – Managed by Me
          6. Slot 6 – Managed by Me"

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
            -d "text=${GROUP_MESSAGE}" \
            -d "parse_mode=HTML"
          )
          
          MESSAGE_ID=$(echo "$RESPONSE" | jq -r '.result.message_id')
          echo "::set-output name=message_id::$MESSAGE_ID"
          echo "Sent group message with ID: $MESSAGE_ID"

      - name: 📌 Pin the Day Before Due Reminder Message (LOUD) in Group
        if: steps.send_group_message_4.outputs.message_id != ''
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/pinChatMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
            -d "message_id=${{ steps.send_group_message_4.outputs.message_id }}" \
            # Removed disable_notification=true for loud pinning
        env:
          MESSAGE_ID: ${{ steps.send_group_message_4.outputs.message_id }}

      - name: 📸 Send QR Code for Payment (4th)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          photo: ./.github/workflows/QRcode.png
          message: |
            Here's the QR code for your convenience: 💳

      - name: ✉️ Send Day Before Due Reminder as PMs to All Members
        run: |
          PM_MESSAGE="⚠️ Hey! Just a gentle reminder for your YouTube Premium contribution.

          Your ₹50 payment is due tomorrow, ${{ env.MONTH }} 5, ${{ env.YEAR }}. The plan renews on ${{ env.MONTH }} 8, ${{ env.YEAR }}.

          Please ensure payment is made soon! Thanks! 🙏
          "
          MEMBER_CHATS=("${{ env.AMIT_CHAT_ID }}" "${{ env.ALAN_CHAT_ID }}" "${{ env.MOURYA_CHAT_ID }}" "${{ env.ABHISHEK_CHAT_ID}}")

          for CHAT_ID in "${MEMBER_CHATS[@]}"; do
            if [ -n "$CHAT_ID" ]; then
              echo "Sending PM to: $CHAT_ID"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=${PM_MESSAGE}" \
                -d "parse_mode=HTML" > /dev/null
            else
              echo "Skipping empty chat ID."
            fi
          done

  # 🗓️ Job 3: DUE DATE! (5th of the month) - Group + PMs + Loud Pinning
  send_telegram_reminder_5th:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 5 5 * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ⬇️ Check out repository code
        uses: actions/checkout@v4

      - name: 📦 Install JQ for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 🗓️ Get current month and year
        id: date
        run: |
          echo "MONTH=$(date +'%B')" >> $GITHUB_ENV
          echo "YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "AMIT_CHAT_ID=${{ secrets.AMIT_CHAT_ID }}" >> $GITHUB_ENV
          echo "ALAN_CHAT_ID=${{ secrets.ALAN_CHAT_ID }}" >> $GITHUB_ENV
          echo "MOURYA_CHAT_ID=${{ secrets.MOURYA_CHAT_ID }}" >> $GITHUB_ENV
          echo "ABHISHEK_CHAT_ID=${{ secrets.ABHISHEK_CHAT_ID }}" >> $GITHUB_ENV

      - name: ✉️ Send Due Date Reminder to Group & Capture ID
        id: send_group_message_5
        run: |
          # Message content for group
          GROUP_MESSAGE="🚨 <b>ACTION REQUIRED: YouTube Premium Payment Due TODAY!</b> 🚨

          Dear Team,

          This is an urgent reminder that today, <b>${{ env.MONTH }} 5, ${{ env.YEAR }}</b>, is the <i>final day</i> to make your <b>₹50 contribution</b> for YouTube Premium. The plan renews on <b>${{ env.MONTH }} 8, ${{ env.YEAR }}</b>.

          Please make your payment <b>immediately</b> to avoid any service disruption! 🛑
          <i>Kindly disregard this message if you have already submitted your payment.</i> Your promptness is highly appreciated! 🙏

          <b>Current Members:</b>
          1. Amit
          2. Alan D'Souza
          3. Mourya Baruah
          4. Abhishek Kumar
          5. Slot 5 – Managed by Me
          6. Slot 6 – Managed by Me"

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
            -d "text=${GROUP_MESSAGE}" \
            -d "parse_mode=HTML"
          )
          
          MESSAGE_ID=$(echo "$RESPONSE" | jq -r '.result.message_id')
          echo "::set-output name=message_id::$MESSAGE_ID"
          echo "Sent group message with ID: $MESSAGE_ID"

      - name: 📌 Pin the Due Date Reminder Message (LOUD) in Group
        if: steps.send_group_message_5.outputs.message_id != ''
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/pinChatMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
            -d "message_id=${{ steps.send_message_5.outputs.message_id }}" \
            # Removed disable_notification=true for loud pinning
        env:
          MESSAGE_ID: ${{ steps.send_message_5.outputs.message_id }}

      - name: 📸 Send QR Code for Payment (5th)
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          photo: ./.github/workflows/QRcode.png
          message: |
            Here's the QR code for immediate payment: 💳

      - name: ✉️ Send Due Date Reminder as PMs to All Members
        run: |
          PM_MESSAGE="🚨 ACTION REQUIRED: Your YouTube Premium payment is due TODAY! 🚨

          Please pay ₹50 immediately to avoid service disruption. Plan renews ${{ env.MONTH }} 8, ${{ env.YEAR }}.

          Ignore if already paid. Your promptness is appreciated! 🙏
          "
          MEMBER_CHATS=("${{ env.AMIT_CHAT_ID }}" "${{ env.ALAN_CHAT_ID }}" "${{ env.MOURYA_CHAT_ID }}" "${{ env.ABHISHEK_CHAT_ID }}")

          for CHAT_ID in "${MEMBER_CHATS[@]}"; do
            if [ -n "$CHAT_ID" ]; then
              echo "Sending PM to: $CHAT_ID"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=${PM_MESSAGE}" \
                -d "parse_mode=HTML" > /dev/null
            else
              echo "Skipping empty chat ID."
            fi
          done

  # 🗓️ Job 4: Renewal Confirmation (8th of the month - Night) - Group + PMs (No Pinning)
  send_telegram_reminder_8th:
    runs-on: ubuntu-latest
    if: github.event.schedule == '30 16 8 * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ⬇️ Check out repository code
        uses: actions/checkout@v4

      - name: 📦 Install JQ for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 🗓️ Get current month and year
        id: date
        run: |
          echo "MONTH=$(date +'%B')" >> $GITHUB_ENV
          echo "YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "AMIT_CHAT_ID=${{ secrets.AMIT_CHAT_ID }}" >> $GITHUB_ENV
          echo "ALAN_CHAT_ID=${{ secrets.ALAN_CHAT_ID }}" >> $GITHUB_ENV
          echo "MOURYA_CHAT_ID=${{ secrets.MOURYA_CHAT_ID }}" >> $GITHUB_ENV
          echo "ABHISHEK_CHAT_ID=${{ secrets.ABHISHEK_CHAT_ID }}" >> $GITHUB_ENV

      - name: ✉️ Send Renewal Confirmation to Group
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: html # Using HTML for consistent rendering
          message: |
            🎉 <b>YouTube Premium: Renewal Successful</b>! 🎉
            Dear Team,

            Great news! Your YouTube Premium family plan has been <b>successfully renewed</b> for <b> ${{ env.MONTH }}, ${{ env.YEAR }}</b>! ✨

            You can continue to enjoy all premium features:
            ✅ Ad-free videos 🚫
            ✅ Background play 🎧
            ✅ YouTube Music Premium 🎶

            <i>Just a quick note: Please ensure your ₹50 contribution for this month has been completed. If not, kindly do so at your earliest convenience.</i> 🙏

            <b>Current Members</b> :
            1. Amit
            2. Alan D'Souza
            3. Mourya Baruah
            4. Abhishek Kumar
            5. Slot 5 – Managed by Me
            6. Slot 6 – Managed by Me

            <br>Thank you for your timely contributions! Enjoy</br> 🥳

      - name: ✉️ Send Renewal Confirmation as PMs to All Members
        run: |
          PM_MESSAGE="🎉 Great news! Your YouTube Premium plan has been successfully renewed for ${{ env.MONTH }}, ${{ env.YEAR }}!

          Enjoy: ✅ Ad-free videos 🚫 ✅ Background play 🎧 ✅ YouTube Music Premium 🎶

          Just a quick note: Please ensure your ₹50 contribution is completed. 🙏
          "
          MEMBER_CHATS=("${{ env.AMIT_CHAT_ID }}" "${{ env.ALAN_CHAT_ID }}" "${{ env.MOURYA_CHAT_ID }}" "${{ env.ABHISHEK_CHAT_ID }}")

          for CHAT_ID in "${MEMBER_CHATS[@]}"; do
            if [ -n "$CHAT_ID" ]; then
              echo "Sending PM to: $CHAT_ID"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=${PM_MESSAGE}" \
                -d "parse_mode=HTML" > /dev/null
            else
              echo "Skipping empty chat ID."
            fi
          done

  # ❌ Job 5: Workflow Failure Notification
  # This job runs only if any previous job in the workflow fails.
  notify_on_failure:
    runs-on: ubuntu-latest
    needs: 
      - send_telegram_reminder_1st
      - send_telegram_reminder_4th
      - send_telegram_reminder_5th
      - send_telegram_reminder_8th
    if: always() && (needs.send_telegram_reminder_1st.result == 'failure' || needs.send_telegram_reminder_4th.result == 'failure' || needs.send_telegram_reminder_5th.result == 'failure' || needs.send_telegram_reminder_8th.result == 'failure')
    steps:
      - name: ⬇️ Check out repository code
        uses: actions/checkout@v4

      - name: 🚨 Send Failure Notification to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            🚨 Workflow Alert: YouTube Premium Reminder Failed! 🚨
            Oye! There was an issue with the Monthly YouTube Premium Reminder workflow. 😟
            Workflow: `${{ github.workflow }}`
            Run ID: `${{ github.run_id }}`
            Status: `Failure` ❌
            Please check the GitHub Actions logs for more details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Jaldi se dekh lo, kuch gadbad ho gayi lagta hai! 😱

